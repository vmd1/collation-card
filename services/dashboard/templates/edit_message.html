{% extends "base.html" %}

{% block content %}
<div class="px-4 py-6">
    <div class="mb-6">
        <a href="{{ request.referrer or url_for('pending_messages') }}" class="text-blue-600 hover:text-blue-800">&larr; Back</a>
    </div>
    
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Edit Message</h1>
    
    <div class="card p-6 max-w-3xl">
        <form method="POST" class="space-y-6">
            <div>
                <div class="flex items-center justify-between mb-2">
                    <label class="block text-sm font-medium text-gray-700">Name(s)</label>
                    <button type="button" id="addNameBtn" class="text-blue-600 hover:text-blue-800 font-medium text-sm flex items-center gap-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Add Person
                    </button>
                </div>
                <div id="nameInputs" class="space-y-2">
                    <!-- Name inputs will be populated by JavaScript -->
                </div>
                <input type="hidden" name="name" id="combinedName">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Message</label>
                <div id="editor" class="bg-white border border-gray-300 rounded-lg" style="min-height: 200px;"></div>
                <input type="hidden" name="content" id="content">
            </div>

            {% if message.image_path or message.video_path %}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Attached Media</label>
                {% if message.media_type == 'image' %}
                    <img src="/media/{{ message.thumb_path }}" alt="Submission image" class="rounded-lg max-w-xs">
                {% elif message.media_type == 'video' %}
                    <video controls class="rounded-lg max-w-xs">
                        <source src="/media/{{ message.video_path }}" type="video/mp4">
                    </video>
                {% endif %}
                <p class="text-xs text-gray-500 mt-1">Note: Media cannot be edited, only name and message content</p>
            </div>
            {% endif %}

            <div class="flex space-x-4">
                <button type="submit" 
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Save Changes
                </button>
                <a href="{{ request.referrer or url_for('pending_messages') }}" 
                   class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
    // Parse existing name into individual names
    const existingName = {{ message.name|tojson }};
    const nameInputsContainer = document.getElementById('nameInputs');
    const addNameBtn = document.getElementById('addNameBtn');
    
    // Split existing name by & and comma to get individual names
    let existingNames = [];
    if (existingName.includes(' & ')) {
        // Handle formatted names like "Person 1 & Person 2" or "Person 1, Person 2 & Person 3"
        const parts = existingName.split(' & ');
        const lastPerson = parts.pop();
        const otherPeople = parts.join(' & ').split(', ').filter(n => n.trim());
        existingNames = [...otherPeople, lastPerson].filter(n => n.trim());
    } else {
        existingNames = [existingName];
    }
    
    // Create input for each existing name
    existingNames.forEach((name, index) => {
        const inputGroup = document.createElement('div');
        inputGroup.className = 'name-input-group flex gap-2';
        inputGroup.innerHTML = `
            <input type="text" name="names[]" value="${name.trim()}" required 
                   class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="Enter name">
            ${index > 0 ? `
                <button type="button" class="remove-name-btn px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            ` : ''}
        `;
        nameInputsContainer.appendChild(inputGroup);
        
        if (index > 0) {
            inputGroup.querySelector('.remove-name-btn').addEventListener('click', function() {
                inputGroup.remove();
            });
        }
    });
    
    // Add name button functionality
    addNameBtn.addEventListener('click', function() {
        const newInputGroup = document.createElement('div');
        newInputGroup.className = 'name-input-group flex gap-2';
        newInputGroup.innerHTML = `
            <input type="text" name="names[]" required 
                   class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   placeholder="Enter name">
            <button type="button" class="remove-name-btn px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        `;
        nameInputsContainer.appendChild(newInputGroup);
        
        newInputGroup.querySelector('.remove-name-btn').addEventListener('click', function() {
            newInputGroup.remove();
        });
    });

    var quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Write your message here...',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['clean']
            ]
        }
    });

    // Set initial content
    quill.root.innerHTML = {{ message.content|tojson }};

    document.querySelector('form').addEventListener('submit', function(e) {
        var content = quill.root.innerHTML;
        document.getElementById('content').value = content;
        
        // Combine all names into comma-separated string
        const nameInputs = document.querySelectorAll('input[name="names[]"]');
        const names = Array.from(nameInputs)
            .map(input => input.value.trim())
            .filter(name => name.length > 0);
        document.getElementById('combinedName').value = names.join(', ');
    });
</script>
{% endblock %}
